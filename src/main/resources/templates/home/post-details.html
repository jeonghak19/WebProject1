<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{header :: head}"></head>

<body>
<div th:replace="~{navbar :: div}"></div>


<div class="container">
    <h1 th:text="${post.postTitle}" style="margin-top:25px;"></h1>
    <div>
        <div style="margin-top: 15px;">
        	<img width="43" height="43" src="https://img.icons8.com/external-becris-lineal-becris/100/external-user-avatars-becris-lineal-becris-1.png" alt="external-user-avatars-becris-lineal-becris-1" style="float: left;">
        	<p th:text="${post.user.name}" style="float: left; margin-left:11px;"></p>
       		<div th:if="${post.createdAt} != null">
       			<!-- <p th:if="${post.createdAt} != null" th:text="${post.createdAt}" style="float: right;"> -->
       			<p th:text="${post.createdAt} != ${post.updatedAt} ? ${post.updatedAt} : ${post.createdAt}" style="float: right;"></p><br><br>
       		</div>
		</div>
		<!-- 좋아요 부분 -->
		<div>
    		<p id="likeCount" th:text="'좋아요 ' + ${likeCount}" style="float: right; margin-left:5px;"></p>
    		<img width="22" height="22" src="https://img.icons8.com/metro/26/like.png" alt="like" style="float: right; margin-left:15px;">
		 </div>	
		
        <p th:text="'조회 ' + ${viewCount}" style="float: right; margin-left:6px;"></p>
        <img width="25" height="25" src="https://img.icons8.com/ios/100/visible--v1.png" alt="visible--v1" style="float: right;">
		
        <br><hr class="border border-2 opacity-50">
        <div style="margin-left:60px; margin-right:60px;">
        	<br><div th:if="${post.imgName} !=null" style="display: flex; justify-content: center;">
            	<img th:src="@{${post.imgPath}}" th:alt="${imgName}" style="max-width: 720px; max-height:540px;">
        	</div><br>        
        	<p th:text="${post.description}" style="font-size:20px; word-spacing:5px; line-height:35px;"></p><br>
        </div>
        
			<!-- 좋아요 버튼 -->
    		<br><br><div th:if="${session.user != null}" style="display: flex; justify-content: center;">
        		<form id="likeForm" th:action="@{/home/posts/like}" method="post">
            		<input type="hidden" name="postId" th:value="${post.postId}">
            		<input type="hidden" name="userId" th:value="${session.user.userId}">
					<span>좋아요</span>
					<button th:if="${liked}" type="button" id="likeButton" onclick="toggleLike()" style="background: none; border: none;">
   						<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="red" class="bi bi-heart-fill" viewBox="0 0 16 16">
  							<path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
					</svg>
					</button>
					<button th:if="${!liked}" type="button" id="likeButton" onclick="toggleLike()" style="background: none; border: none;">
						<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="red" class="bi bi-heart" viewBox="0 0 16 16">
  							<path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
						</svg>
					</button>
        		</form>
    		</div>    		
		
		<hr class="border border-2 opacity-50">
        <form th:if="${session.user != null and session.user.userId == post.user.userId}" action="/home/posts/update">
            <input type="hidden" name="boardId" th:value="${boardId}">
            <input type="hidden" name="postId" th:value="${post.postId}">
            <input type="hidden" name="imgName" th:value="${imgName}">
            <button type="submit" class="btn btn-warning" style="float: right; margin-left: 8px;">수정</button>
        </form>    
        <a th:href="@{/home/posts/search(boardId = ${boardId})}" class="btn btn-secondary" style="float: right;">목록</a>
        
        
        <!-- 정렬 순서 선택 -->
        <form th:action="@{/home/posts/{postId}(postId=${post.postId})}" method="get">
            <input type="hidden" name="boardId" th:value="${boardId}">
            <input type="hidden" name="page" th:value="${currentPage}">
            <input type="hidden" name="size" th:value="${size}">
            <button type="submit" name="sortOrder" value="desc" class="btn btn-info">최신순</button>
            <button type="submit" name="sortOrder" value="asc" class="btn btn-info">과거순</button>
        </form>


<!-- 버튼 클릭 함수 호출 -->
<script type="text/javascript">
function toggleLike() {
    const form = document.getElementById('likeForm');
    const postId = form.querySelector('input[name="postId"]').value;
    const userId = form.querySelector('input[name="userId"]').value;

    fetch(`/home/posts/like`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ postId: postId, userId: userId })
    })
    .then(response => response.json())
    .then(data => {
        const likeButton = document.getElementById('likeButton');
        const likeCount = document.getElementById('likeCount');
        
        if (data.liked) {
            likeButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="red" class="bi bi-heart-fill" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/></svg>`;
        } else {
            likeButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="red" class="bi bi-heart" viewBox="0 0 16 16"><path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/></svg>`;
        }
        
        likeCount.textContent = `좋아요: ${data.likeCount}`;
    })
}
</script>

        <!-- 댓글 리스트 -->
        <form th:action="@{/home/posts/{postId}/comments(postId=${post.postId})}" method="post">
            <textarea name="content" placeholder="댓글을 입력하세요" required></textarea>
            <input type="hidden" name="boardId" th:value="${boardId}">
            <button type="submit" class="btn btn-primary">댓글 작성</button>
        </form>

        <div class="comment-list mt-4">
            <div th:each="comment : ${comments}">
                <div class="comment mb-3">
                    <!-- 수정 및 삭제 버튼 -->
                    <div th:if="${comment.user != null and session.user != null and comment.user.userId == session.user.userId}">
                        <form th:action="@{/home/posts/{postId}/comments/{commentId}/delete(postId=${post.postId}, commentId=${comment.commentId})}"
                              method="post" class="d-inline">
                            <input type="hidden" name="boardId" th:value="${boardId}">
                            <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                        </form>

                        <!-- 수정 버튼 (모달 창 열기) -->
                        <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal"
                                data-bs-target="#editCommentModal" 
                                th:data-comment-id="${comment.commentId}"
                                th:data-comment-content="${comment.content}"
                                th:data-post-id="${post.postId}">
                            수정
                        </button>
                    </div>

                    <!-- 댓글 작성자의 이름을 표시하는 부분 -->
                    <p><strong th:text="${comment.user != null ? comment.user.name : 'Anonymous'}">User Name</strong>
                        <span th:text="${comment.commentTime}">Time</span>
                    </p>
                    <p th:text="${comment.content}">Content</p>
                </div>
            </div>
            
			<div class="pagination">
                <ul class="pagination">
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{/home/posts/{postId}(postId=${post.postId}, boardId=${boardId}, page=${currentPage - 1})}">Previous</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                        <a class="page-link" th:href="@{/home/posts/{postId}(postId=${post.postId}, boardId=${boardId}, page=${i})}" th:text="${i + 1}"></a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/home/posts/{postId}(postId=${post.postId}, boardId=${boardId}, page=${currentPage + 1})}">Next</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 댓글 수정 모달 -->
<div class="modal fade" id="editCommentModal" tabindex="-1" aria-labelledby="editCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCommentModalLabel">댓글 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCommentForm">
                    <div class="mb-3">
                        <textarea class="form-control" id="editCommentContent" rows="3" required></textarea>
                    </div>
                    <input type="hidden" id="commentId">
                    <input type="hidden" id="postId"> <!-- 추가: postId를 hidden으로 저장 -->
                    <button type="submit" class="btn btn-primary">수정하기</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{footer :: footer}"></div>

<!-- Bootstrap JS (필요한 경우) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // 수정 버튼 클릭 시 모달에 댓글 정보 채우기
    const editButtons = document.querySelectorAll('.btn-warning');
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            const commentContent = this.getAttribute('data-comment-content');
            const postId = this.getAttribute('data-post-id'); // postId를 가져옴
            
            // 모달에 댓글 정보 채우기
            document.getElementById('commentId').value = commentId;
            document.getElementById('editCommentContent').value = commentContent;
            document.getElementById('postId').value = postId; // postId도 채우기
        });
    });

    // 수정 폼 제출
    const form = document.getElementById('editCommentForm');
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        const commentId = document.getElementById('commentId').value;
        const postId = document.getElementById('postId').value;
        const newContent = document.getElementById('editCommentContent').value;

        // 서버로 수정된 댓글 내용 전송 (AJAX 사용)
        fetch(`/home/posts/${postId}/comments/${commentId}/edit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: newContent })  // JSON 형식으로 데이터 전송
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('댓글이 수정되었습니다.');
                location.reload();  // 새로고침으로 댓글 내용 반영
            } else {
                alert('수정에 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});
</script>

</body>
</html>
